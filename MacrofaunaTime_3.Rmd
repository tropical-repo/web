---
title: "3. Macrofauna Temporal Analysis"
description: |
  Reproducible workflow for ... In this workflow, ....
author:
#  - name: Noelle Lucey
#    url: https://example.com/norajones
#    affiliation: Spacely Sprockets
#    affiliation_nrl: https://example.com/spacelysprokets
# bibliography: assets/cite.bib
output:
    distill::distill_article:
     # css: assets/styles.css
      toc: true
      toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("ggplot2")
library("viridis")
library("hrbrthemes")
library("xts")
library("scales")
library("forecast")
library("reshape2")
library("smooth")
library("Mcomp")
library("dygraphs")
library("plotly")
library("TTR")
library("quantmod")
```

## Assessing ecological integrity over time

First we explore the data, looking at the number of living animals found in each site through time. These animals were sorted by two different size classes (250 um and 500 um). The time frame in which these environmental and macrofaunal samples were collected was approx. 3 years, whereas the microbial samples were only collected for one year. We explore both the full time-series and the shorter, one year time-series corresponding to the microbial diversity.

Load and format data.
```{r data}
ds <- read.csv("T_REPO_raw.csv", header = TRUE) # all macro data

# Format dates
ds$date <- as.Date(ds$date, format = "%m/%d/%y", tz = "EST")
dateWindow <- c("2017-10-04", "2020-02-04")

# exclude combined and first size fraction (this was not consistently collected)
ds_combo <- ds[ds$size == "combined",]
ds<- ds[ds$size != "combined",]
ds<- ds[ds$size != "125",] 

# select only time comparable to microbial dataset:
ds_2018 <- ds[ds$week != "WXX",] 

# Order sites and choose colors for size classes
ds$site  <- ordered(ds$site, 
            levels= c("Pastores", "Almirante","Cristobal", "P_Caracol"))
col <- c("#0072B2", "#D55E00")

```

## Occurance of living macrofauna

First plot the total_organisms each week for each site 
Here is an interactive plot the each site

```{r occurrances interactive}
# Look at occurrences by site over time:
alm <- ds[which(ds$site == 'Almirante'),]
Alm <- xts(x = alm$total_organisms, order.by = alm$date)
past <- ds[which(ds$site == 'Pastores'),]
Past <- xts(x = past$total_organisms, order.by = past$date)
pucl <- ds[which(ds$site == 'P_Caracol'),]
P.Cara <- xts(x = pucl$total_organisms, order.by = pucl$date)
cris <- ds[which(ds$site == 'Cristobal'),]
Cris <- xts(x = cris$total_organisms, order.by = cris$date)
sites <- cbind(Alm,Past,P.Cara,Cris) #  raw time-series with all sites

## Interactive Figure with time-series data: 
dygraph(sites, main = "Number of Occurances") %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3))%>% 
  dyRangeSelector(dateWindow = dateWindow)%>% 
  dyMultiColumn()
```

Here we plot differences in occurrences of organisms from different size classes. This plot variability with time of both size classes at each site. Shaded gray areas represent the hypoxic seasons. 

```{r occurrances, echo=FALSE}

p_fulltime <- ggplot(ds, aes(fill=size, y=total_organisms, x=date)) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = col,
    breaks = c("250", "500"),
    labels = c("250 um", "500 um")) +
  ggtitle("Macrofauna Occurances by size") +
  facet_grid(site ~ ., , scales = "free_y") +
  theme_bw(base_size = 12) +
  scale_x_date(breaks = date_breaks("6 month"),                
               labels = date_format("%b-%y")) +
  theme(legend.position="bottom") +
  xlab("month-year") +
  ylab("number of live organisms") +
  annotate("rect",
           xmin = as.Date("2017-8-15"), xmax = as.Date("2017-12-31"),
           ymin = -Inf, ymax = Inf,  fill = "grey", alpha=.2) +
  annotate("rect",
         xmin = as.Date("2018-8-15"), xmax = as.Date("2018-12-31"),
         ymin = -Inf, ymax = Inf,  fill = "grey", alpha=.2) +
  annotate("rect",
         xmin = as.Date("2019-8-15"), xmax = as.Date("2019-12-31"),
         ymin = -Inf, ymax = Inf,  fill = "grey", alpha=.2)
p_fulltime
```

Plot the time period of interest (i.e.corresponding to the microbial dataset)


```{R}
p_2018 <- ggplot(ds_2018, aes(fill=size, y=total_organisms, x=date)) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = col,
                    breaks = c("250", "500"),
                    labels = c("250 um", "500 um")) +
  ggtitle("Total Live Macrofaunal Occurances") +
  facet_grid(site ~ .) +
  theme_bw(base_size = 12) +
  scale_x_date(breaks = date_breaks("3 month"),                
               labels = date_format("%b-%y")) +
  theme(legend.position="bottom") +
  xlab("month-year") +
  ylab("number of live organisms") +
  annotate("rect",
           xmin = as.Date("2017-9-15"), xmax = as.Date("2017-12-31"),
           ymin = -Inf, ymax = Inf,  fill = "grey", alpha=.2) +
  annotate("rect",
           xmin = as.Date("2018-8-15"), xmax = as.Date("2018-11-01"),
           ymin = -Inf, ymax = Inf,  fill = "grey", alpha=.2)
p_2018
```

Here is the same plot, with the number of occurrences zoomed into the max for each site. So, the y axes aren't comparable but it is easier to see trends.

```{R}
p_2018_zoom <- ggplot(ds_2018, aes(fill=size, y=total_organisms, x=date)) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = col,
                    breaks = c("250", "500"),
                    labels = c("250 um", "500 um")) +
  ggtitle("Macrofauna Occurances- 2017-2018, zoomed in") +
  facet_grid(site ~ ., scales = "free_y") +
  theme_bw(base_size = 12) +
  scale_x_date(breaks = date_breaks("3 month"),                
               labels = date_format("%b-%y")) +
  theme(legend.position="bottom") +
  xlab("month-year") +
  ylab("number of live organisms") +
  annotate("rect",
           xmin = as.Date("2017-9-15"), xmax = as.Date("2017-12-31"),
           ymin = -Inf, ymax = Inf,  fill = "grey", alpha=.2) +
  annotate("rect",
           xmin = as.Date("2018-8-15"), xmax = as.Date("2018-11-01"),
           ymin = -Inf, ymax = Inf,  fill = "grey", alpha=.2)
p_2018_zoom
```

# Diversity over time

```{R, diversity-time}
# add data 
```

